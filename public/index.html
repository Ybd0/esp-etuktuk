<!DOCTYPE html>
<html lang="de">
<head>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
    	/* Modal Styling */
    	#booking-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;
    	}
    	#booking-content {
            background: white; width: 80%; max-width: 800px; height: 80%; padding: 20px;
            border-radius: 8px; overflow: auto; display: flex; flex-direction: column;
    	}
    	#calendar { margin-top: 20px; flex-grow: 1; }
    </style>
    <meta charset="UTF-8">
    <title>ESP32 IoT Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; display: none; }
        
        #controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: none;
        }
        .btn { padding: 10px 20px; cursor: pointer; color: white; border: none; border-radius: 4px; font-size: 16px; margin-top: 10px; width: 100%;}
        .btn-on { background-color: #28a745; }
        .btn-off { background-color: #dc3545; }
        .logout-btn { position: absolute; bottom: 20px; left: 20px; z-index: 1000; padding: 10px; background: white; cursor: pointer;}
    </style>
</head>
<body>
	<div id="booking-modal">
		<div id="booking-content">
			<div style="display:flex; justify-content:space-between;">
				<h2>ESP Reservieren</h2>
				<button onclick="closeModal()" class="btn btn-off" style="width:auto;">Schlie√üen</button>
			</div>
			<p>Klicke und ziehe im Kalender, um einen Zeitraum zu markieren (Max 2 Std/Woche).</p>
			<div id="calendar"></div>
		</div>
	</div>

	<button id="loginBtn" class="logout-btn">Login</button>

    <div id="controls">
        <h3>ESP32 <span id="role-display"></span></h3>
        <p>ID: <span id="esp-id">--</span></p>
        <div id="admin-panel" style="display:none;">
            <button id="toggleBtn" class="btn btn-on" onclick="toggleLed()">LED Schalten</button>
        </div>
        <p id="viewer-msg" style="display:none; color: grey;">Nur Beobachter</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@26.2.2/lib/keycloak.min.js"></script>

	<script type="module">
		// 1. IMPORT: Keycloak als modernes Modul laden 
		import Keycloak from 'https://cdn.jsdelivr.net/npm/keycloak-js@26.2.2/lib/keycloak.min.js';
		import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js"; // Socket.IO auch modern laden

		let calendar; // Globaler Kalender
		let socket;
		let keycloak;
		let espMarker = null;
		let isLedOn = false;

		// Funktion um Modal zu √∂ffnen (wird vom Marker aufgerufen)
		window.openBooking = function() {
			if (!keycloak.authenticated) {
				alert("Bitte erst einloggen!");
				keycloak.login();
				return;
			}
			
			document.getElementById('booking-modal').style.display = 'flex';
			
			// Kalender erst rendern wenn sichtbar
			if (!calendar) initCalendar();
			else { 
				calendar.refetchEvents(); 
				calendar.render(); 
			}
		};

		window.closeModal = function() {
			document.getElementById('booking-modal').style.display = 'none';
		};

		// Keycloak Konfiguration
		const keycloakConfig = {
			url: 'https://auth.birguel.de', 
			realm: 'iot-project',
			clientId: 'esp-web-app'
		};

		// Karte initialisieren
		const map = L.map('map', { attributionControl: false }).setView([52.5200, 13.4050], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
		L.control.attribution({ prefix: false }).addAttribution('¬© OpenStreetMap').addTo(map);

		// Initialisierung
		function initKeycloak() {
			console.log("Starte Keycloak...");
			
			keycloak = new Keycloak(keycloakConfig);

			keycloak.init({
				onLoad: 'check-sso',
				checkLoginIframe: false, // WICHTIG gegen Endlosschleifen
				pkceMethod: 'S256'       // WICHTIG f√ºr saubere URLs
			}).then(authenticated => {
				
				startSocket(keycloak.token);
				setupUI(authenticated);

				if (authenticated) {
					console.log("Login OK");
					// URL aufr√§umen
					window.history.replaceState({}, document.title, window.location.pathname);
					
					//setupUI();
					//startSocket(keycloak.token);

					// Token Refresh Loop
					setInterval(() => {
						keycloak.updateToken(70).catch(() => {
							console.error('Refresh fehlgeschlagen');
							keycloak.logout();
						});
					}, 60000);
				} else {
					// window.location.reload(); - Nur setzten, wenn die Seite nur mit Login erreichbar sein soll
				}
			}).catch(err => {
				console.error("Init Fehler:", err);
				alert("Fehler bei Keycloak Verbindung: " + JSON.stringify(err));
			});
		}

		function setupUI(isAuthenticated) {
			document.getElementById('map').style.display = 'block';
			setTimeout(() => map.invalidateSize(), 100);

			const loginBtn = document.getElementById('loginBtn'); 
			
			if (isAuthenticated) {
				loginBtn.innerText = "Logout";
				loginBtn.onclick = () => keycloak.logout();
				
				// Admin Panel Logik
				const roles = keycloak.realmAccess ? keycloak.realmAccess.roles : [];
				if(roles.includes('admin')) {
					document.getElementById('admin-panel').style.display = 'block';
					document.getElementById('role-display').innerText = "(Admin)";
				} else {
					// Eingeloggt, aber kein Admin (nur Viewer Account)
					 document.getElementById('role-display').innerText = "(Viewer)";
				}
			} else {
				// Gast
				loginBtn.innerText = "Login / Registrieren";
				loginBtn.onclick = () => keycloak.login();
				
				document.getElementById('role-display').innerText = "(Gast)";
				// Dasas Admin Panel wird nicht angezeigt, aber wenn man auf den Marker klickt,
				// wird ein Login-Hinweis Button angezeigt (siehe updateButtonUI Logik unten)
			}
		}
		
		function startSocket(token) {
			// Socket verbindung mit Token
			socket = io({
				auth: { token: token }
			});

			socket.on('update-map', (data) => {
				if (!espMarker) {
					espMarker = L.marker([data.lat, data.lon]).addTo(map);
					espMarker.on('click', () => {
						document.getElementById('controls').style.display = 'block';
						document.getElementById('esp-id').innerText = data.id;
						
						// Button Logik beim Klick auf Marker pr√ºfen
						updateControlPanel();
					});
					espMarker.bindPopup(`
						<div style="text-align: center;">
							<b>ESP32 (${data.id})</b><br>
							<hr style="margin: 5px 0;">
							<button onclick="window.openBooking()" 
									style="background-color: #f39c12; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
								üìÖ Zeit Buchen
							</button>
						</div>
					`);
				} else {
					espMarker.setLatLng([data.lat, data.lon]);
				}
			});

			socket.on('cmd-led', (cmd) => {
				isLedOn = cmd.value;
				updateBtnColor();
			});

			socket.on('error-msg', (msg) => alert(msg));
		}
		
		
		function updateControlPanel() {
			// Der Button wird immer angezeigt, aber seine Funktion √§ndert sich
			// basierend auf dem Login Status
			const panel = document.getElementById('admin-panel');
			
			// Das Panel wird immer eingeblendet, damit man den Knopf sieht
			panel.style.display = 'block';
			
			const btn = document.getElementById('toggleBtn');
			
			if (keycloak.authenticated) {
				// User ist eingeloggt -> Button schaltet LED
				updateBtnColor();
			} else {
				// Gast -> Button fordert Login
				btn.className = "btn";
				btn.style.backgroundColor = "#3498db"; // Blau f√ºr Info
				btn.innerText = "Zum Steuern einloggen";
			}
		}

		// Die Funktion hinter dem Button
		window.toggleLed = function() {
			if (!keycloak.authenticated) {
				// Wenn nicht eingeloggt -> Ab zu Keycloak
				// Keycloak bietet dort dann Login UND Registrieren an
				keycloak.login();
			} else {
				// Wenn eingeloggt -> Schalten
				if(socket) socket.emit('toggle-led', { value: !isLedOn });
			}
		};

		// --- BUTTON FUNKTIONEN ---
		// Da der Code in einem Modul ist, m√ºssen Funktionen, die im HTML (onclick=...)
		// aufgerufen werden, manuell "√∂ffentlich" gemacht werden:

		window.toggleLed = function() {
			if(socket) socket.emit('toggle-led', { value: !isLedOn });
		};

		window.logout = function() {
			keycloak.logout({ redirectUri: window.location.origin });
		};
		
		// UI Helper (muss nicht global sein)
		function updateBtnColor() {
			// Nur Farbe √§ndern, wenn wir wirklich eingeloggt sind
			if (!keycloak.authenticated) return; 

			const btn = document.getElementById('toggleBtn');
			if(btn) btn.className = isLedOn ? "btn btn-off" : "btn btn-on";
			if(btn) btn.innerText = isLedOn ? "LED Ausschalten" : "LED Einschalten";
		}
		
		function initCalendar() {
			var calendarEl = document.getElementById('calendar');
			calendar = new FullCalendar.Calendar(calendarEl, {
				initialView: 'timeGridWeek',
				locale: 'de',
				headerToolbar: { left: 'prev,next today', center: 'title', right: 'timeGridWeek,timeGridDay' },
				selectable: true,
				allDaySlot: false,
				slotMinTime: "08:00:00", // Startzeit Anzeige
				slotMaxTime: "22:00:00",
				events: '/api/bookings', // Hier l√§dt er die Termine vom Server!
				
				// Wenn Benutzer einen Bereich markiert
				select: async function(info) {
					const confirmBooking = confirm(`Buchen von ${info.start.toLocaleTimeString()} bis ${info.end.toLocaleTimeString()}?`);
					
					if (confirmBooking) {
						// API Aufruf zum Buchen
						const res = await fetch('/api/bookings', {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
								'Authorization': 'Bearer ' + keycloak.token
							},
							body: JSON.stringify({
								espId: 'ESP-Real-Hardware', // Hier sp√§ter dynamisch
								start: info.startStr,
								end: info.endStr
							})
						});

						const data = await res.json();
						if (res.ok) {
							alert("Erfolgreich gebucht!");
							calendar.refetchEvents(); // Aktualisieren
						} else {
							alert("Fehler: " + data.error);
						}
					}
					calendar.unselect();
				}
			});
			calendar.render();
		}

		// Starten
		initKeycloak();
	</script>
</body>
</html>
