<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>ESP32 IoT Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; display: none; }
        
        #controls {
            position: absolute; top: 20px; right: 20px; z-index: 1000;
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            display: none;
        }
        .btn { padding: 10px 20px; cursor: pointer; color: white; border: none; border-radius: 4px; font-size: 16px; margin-top: 10px; width: 100%;}
        .btn-on { background-color: #28a745; }
        .btn-off { background-color: #dc3545; }
        .logout-btn { position: absolute; bottom: 20px; left: 20px; z-index: 1000; padding: 10px; background: white; cursor: pointer;}
    </style>
</head>
<body>

	<button id="loginBtn" class="logout-btn">Login</button>

    <div id="controls">
        <h3>ESP32 <span id="role-display"></span></h3>
        <p>ID: <span id="esp-id">--</span></p>
        <div id="admin-panel" style="display:none;">
            <button id="toggleBtn" class="btn btn-on" onclick="toggleLed()">LED Schalten</button>
        </div>
        <p id="viewer-msg" style="display:none; color: grey;">Nur Beobachter</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keycloak-js@26.2.2/lib/keycloak.min.js"></script>

	<script type="module">
		// 1. IMPORT: Wir laden Keycloak als modernes Modul
		import Keycloak from 'https://cdn.jsdelivr.net/npm/keycloak-js@26.2.2/lib/keycloak.min.js';
		import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js"; // Socket.IO auch modern laden

		let socket;
		let keycloak;
		let espMarker = null;
		let isLedOn = false;

		// Deine Konfiguration
		const keycloakConfig = {
			url: 'https://auth.birguel.de', 
			realm: 'iot-project',
			clientId: 'esp-web-app'
		};

		// Karte initialisieren
		const map = L.map('map', { attributionControl: false }).setView([52.5200, 13.4050], 13);
		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
		L.control.attribution({ prefix: false }).addAttribution('© OpenStreetMap').addTo(map);

		// Initialisierung
		function initKeycloak() {
			console.log("Starte Keycloak...");
			
			keycloak = new Keycloak(keycloakConfig);

			keycloak.init({
				onLoad: 'check-sso',
				checkLoginIframe: false, // WICHTIG gegen Endlosschleifen
				pkceMethod: 'S256'       // WICHTIG für saubere URLs
			}).then(authenticated => {
				
				startSocket(keycloak.token);
				setupUI(authenticated);

				if (authenticated) {
					console.log("Login OK");
					// URL aufräumen
					window.history.replaceState({}, document.title, window.location.pathname);
					
					//setupUI();
					//startSocket(keycloak.token);

					// Token Refresh Loop
					setInterval(() => {
						keycloak.updateToken(70).catch(() => {
							console.error('Refresh fehlgeschlagen');
							keycloak.logout();
						});
					}, 60000);
				} else {
					// window.location.reload(); - Nur setzten, wenn die Seite nur mit Login erreichbar sein soll
				}
			}).catch(err => {
				console.error("Init Fehler:", err);
				alert("Fehler bei Keycloak Verbindung: " + JSON.stringify(err));
			});
		}

		function setupUI(isAuthenticated) {
			document.getElementById('map').style.display = 'block';
			setTimeout(() => map.invalidateSize(), 100);

			const loginBtn = document.getElementById('loginBtn'); // Button den wir gleich im HTML adden müssen
			
			if (isAuthenticated) {
				loginBtn.innerText = "Logout";
				loginBtn.onclick = () => keycloak.logout();
				
				// Admin Panel Logik
				const roles = keycloak.realmAccess ? keycloak.realmAccess.roles : [];
				if(roles.includes('admin')) {
					document.getElementById('admin-panel').style.display = 'block';
					document.getElementById('role-display').innerText = "(Admin)";
				} else {
					// Eingeloggt, aber kein Admin (nur Viewer Account)
					 document.getElementById('role-display').innerText = "(Viewer)";
				}
			} else {
				// Gast
				loginBtn.innerText = "Login / Registrieren";
				loginBtn.onclick = () => keycloak.login();
				
				document.getElementById('role-display').innerText = "(Gast)";
				// Wir zeigen das Admin Panel NICHT an, aber wenn man auf den Marker klickt,
				// zeigen wir einen Login-Hinweis Button an (siehe updateButtonUI Logik unten)
			}
		}
		
		function startSocket(token) {
			// Socket verbindung mit Token
			socket = io({
				auth: { token: token }
			});

			socket.on('update-map', (data) => {
				if (!espMarker) {
					espMarker = L.marker([data.lat, data.lon]).addTo(map);
					espMarker.on('click', () => {
						document.getElementById('controls').style.display = 'block';
						document.getElementById('esp-id').innerText = data.id;
						
						// Button Logik beim Klick auf Marker prüfen
						updateControlPanel();
					});
				} else {
					espMarker.setLatLng([data.lat, data.lon]);
				}
			});

			socket.on('cmd-led', (cmd) => {
				isLedOn = cmd.value;
				updateBtnColor();
			});

			socket.on('error-msg', (msg) => alert(msg));
		}
		
		
		function updateControlPanel() {
			// Wir zeigen den Button immer an, aber ändern seine Funktion
			// basierend auf dem Login Status
			const panel = document.getElementById('admin-panel');
			
			// Wir blenden das Panel immer ein, damit man den Knopf sieht
			panel.style.display = 'block';
			
			const btn = document.getElementById('toggleBtn');
			
			if (keycloak.authenticated) {
				// User ist eingeloggt -> Button schaltet LED
				updateBtnColor();
			} else {
				// Gast -> Button fordert Login
				btn.className = "btn";
				btn.style.backgroundColor = "#3498db"; // Blau für Info
				btn.innerText = "Zum Steuern einloggen";
			}
		}

		// Die Funktion hinter dem Button
		window.toggleLed = function() {
			if (!keycloak.authenticated) {
				// Wenn nicht eingeloggt -> Ab zu Keycloak
				// Keycloak bietet dort dann Login UND Registrieren an
				keycloak.login();
			} else {
				// Wenn eingeloggt -> Schalten
				if(socket) socket.emit('toggle-led', { value: !isLedOn });
			}
		};

		// --- BUTTON FUNKTIONEN (WICHTIG!) ---
		// Da wir in einem Modul sind, müssen wir Funktionen, die im HTML (onclick=...)
		// aufgerufen werden, manuell "öffentlich" machen:

		window.toggleLed = function() {
			if(socket) socket.emit('toggle-led', { value: !isLedOn });
		};

		window.logout = function() {
			keycloak.logout({ redirectUri: window.location.origin });
		};
		
		// UI Helper (muss nicht global sein)
		function updateBtnColor() {
			// Nur Farbe ändern, wenn wir wirklich eingeloggt sind
			if (!keycloak.authenticated) return; 

			const btn = document.getElementById('toggleBtn');
			if(btn) btn.className = isLedOn ? "btn btn-off" : "btn btn-on";
			if(btn) btn.innerText = isLedOn ? "LED Ausschalten" : "LED Einschalten";
		}

		// Starten
		initKeycloak();
	</script>
</body>
</html>
